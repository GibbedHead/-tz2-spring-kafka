# Реализация системы мониторинга с использованием Spring Kafka

Выполнено как задание в открытой школе T1:
> Создать систему мониторинга, которая будет отслеживать работу различных компонентов вашего приложения с помощью Spring Kafka. Эта система будет включать в себя Producer для отправки метрик, Consumer для их обработки и анализа, а также REST API для просмотра метрик.

## Запуск

* Клонировать проект
* Скомпилировать
* Запустить docker контейнеры
* Все java приложения будут запущены в своих контейнерах
```bash
git clone https://github.com/GibbedHead/tz2-spring-kafka.git
cd .\tz2-spring-kafka\
mvn package
docker compose up -d
```

## Описание модулей

Проект написан для Java 17. Использует Postgresql 16, Kafka/Zookeeper 7.6.1.

* ### monitored-app
Приложение, параметры которго логируются. Простое spring boot web приложение с тестовым контроллером. В нем создан компонент, имеющий метод, который через аннотацию @Scheduled, отсылает полученные через spring actuator метрики на эндпоинт продюсера
* ### metrics-producer
Приложение, реализующее эндроинт получения записи о метрике, и сохраняющее эту запись в kafka. В файле [metrics-producer-api-docs.yaml](metrics-producer-api-docs.yaml) содержится OpenApi спецификация реализованного API.
* ### metrics-consumer
Приложение, читающее записи метрик из kafka и сохраняющее в базу данных. Предоставляет api для получения списка имен сохраненных метрик и получени записей по имени метрики. В файле [metrics-consumer-api-docs.yaml](metrics-consumer-api-docs.yaml) содержится OpenApi спецификация реализованного API.

## Полная задача
> Тема: Реализация системы мониторинга с использованием Spring Kafka
> 
> Цель:
Создать систему мониторинга, которая будет отслеживать работу различных компонентов вашего приложения с помощью Spring Kafka. Эта система будет включать в себя Producer для отправки метрик, Consumer для их обработки и анализа, а также REST API для просмотра метрик.
Общая архитектура системы:
>
> Producer Service:
Создать микросервис "Metrics Producer", который будет отслеживать и собирать метрики работы приложения и отправлять их в Kafka топик "metrics-topic".
Реализовать следующие API для взаимодействия с микросервисом:
POST /metrics: Отправка метрик работы приложения в формате JSON. Метрики могут включать информацию о производительности, использовании ресурсов, ошибках и т. д.
>
> Consumer Service:
Создать микросервис "Metrics Consumer", который будет принимать метрики из Kafka топика "metrics-topic" и анализировать их для выявления проблем и трендов.
Реализовать обработку метрик и вывод статистики в логи или базу данных для последующего анализа.
>
> REST API:
Реализовать REST API в микросервисе "Metrics Consumer" для просмотра метрик.
GET /metrics: Получение списка всех метрик.
GET /metrics/{id}: Получение конкретной метрики по ее идентификатору.

## Детали реализации

### monitored-app
Через MetricsEndpoint получает значения метрик, перечисленных в переменной из application.yml.

Через WebClient асинхронно отправляет dto на эндпоинт продюсера.
### metrics-producer
Через KafkaTemplate отправляет полученные с эндпоинта dto в топик kafka.
### metrics-consumer
Создан метод с аннотацией @KafkaListener, читающий топик и сохраняющий в базу данных. Метод сделан транзационным. Не сохраненные в базу сообщения из топика уходят в dlt через 2 попытки.

Реализовано rest api для получения сохраненных метрик

## Тесты postman

В файле [postman.json](postman.json) приложена простая коллекция для тестов:
* Папки для продюсера и консьюмера
* В папке **API** лежат запросы ко всем используемым эндпоинтам
* В папке **Tests** простые тесты добавляющие записи о метриках и тесты получения различной статистики по ним